// LLMManager.swiftì˜ í•µì‹¬ ë¶€ë¶„
func loadModel() async {
    #if targetEnvironment(simulator)
    print("ì‹œë®¬ë ˆì´í„°: ëª¨ë¸ ë¡œë“œ ê±´ë„ˆëœ€")
    return
    #endif
    
    do {
        // ëª¨ë¸ íŒŒì¼ ê²½ë¡œ ì„¤ì •
        let modelsPath = getSaveDirectoryURL()
        let modelFileName = "\(selectedModel.fileName)"
        let modelFilePath = modelsPath.appendingPathComponent(modelFileName)
        
        print("ğŸ“‚ ëª¨ë¸ íŒŒì¼ ê²½ë¡œ: \(modelFilePath.path)")
        
        // íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° í¬ê¸° ì¶œë ¥
        if let fileSize = try? FileManager.default.attributesOfItem(atPath: modelFilePath.path)[.size] as? UInt64 {
            print("ğŸ“Š ëª¨ë¸ íŒŒì¼ í¬ê¸°: \(fileSize) ë°”ì´íŠ¸")
            
            // íŒŒì¼ ì½ê¸° í…ŒìŠ¤íŠ¸
            if let fileHandle = FileHandle(forReadingAtPath: modelFilePath.path) {
                let sampleData = fileHandle.readData(ofLength: 1024)
                print("âœ… íŒŒì¼ ì½ê¸° ì„±ê³µ: ì´ \(fileSize) ë°”ì´íŠ¸, ìƒ˜í”Œ \(sampleData.count) ë°”ì´íŠ¸")
                fileHandle.closeFile()
            } else {
                print("âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
            }
        } else {
            print("âŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        }
        
        // íŒŒì¼ ë³´í˜¸ ì†ì„± ì œê±°
        try? modelFilePath.removeProtection()
        print("âœ… íŒŒì¼ ë³´í˜¸ ì†ì„± ì œê±° ì™„ë£Œ")
        
        // ëª¨ë¸ êµ¬ì„±
        print("ğŸ“„ ëª¨ë¸ ì ˆëŒ€ ê²½ë¡œ: \(modelFilePath.path)")
        let localModel: LLMLocalModel = .custom(id: modelFilePath.path)
        let schema = LLMLocalSchema(model: localModel)
        
        print("âœ… ìŠ¤í‚¤ë§ˆ ë‚´ìš©: \(schema)")
        llmSession = try runner(with: schema)
        print("ğŸ“ ìƒì„±ëœ ì„¸ì…˜ ì •ë³´: \(String(describing: llmSession))")
        modelLoaded = true
        print("ğŸš€ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ! modelLoaded = \(modelLoaded)")
    } catch {
        print("âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: \(error.localizedDescription)")
        modelLoaded = false
        downloadError = "ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: \(error.localizedDescription)"
    }
}

// ì•± ë‚´ ë‹¤ìš´ë¡œë“œ êµ¬í˜„ (AppModel.swiftì—ì„œ)
func downloadModel() {
    downloadTask?.cancel()
    
    let modelId = "tinyllama-1.1b-chat-v1.0.Q4_0"
    let modelURL = URL(string: "https://huggingface.co/TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF/resolve/main/tinyllama-1.1b-chat-v1.0.Q4_0.gguf")!
    
    isDownloading = true
    downloadError = nil
    downloadProgress = 0
    
    print("\n=== ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹œì‘ ===")
    print("ğŸ“¥ ë‹¤ìš´ë¡œë“œ URL: \(modelURL)")
    
    // ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
    downloadTask = Task {
        do {
            let documentsPath = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first!
            let downloadDirectory = documentsPath.appendingPathComponent("LLMDownloads", isDirectory: true)
            
            print("ğŸ“‚ ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬: \(downloadDirectory.path)")
            
            // ë””ë ‰í† ë¦¬ ìƒì„±
            if !FileManager.default.fileExists(atPath: downloadDirectory.path) {
                try FileManager.default.createDirectory(at: downloadDirectory,
                                                     withIntermediateDirectories: true,
                                                     attributes: nil)
                print("âœ… ë‹¤ìš´ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±ë¨")
            }
            
            let modelPath = downloadDirectory.appendingPathComponent(modelId)
            print("ğŸ“„ ëª¨ë¸ íŒŒì¼ ì €ì¥ ê²½ë¡œ: \(modelPath.path)")
            
            // ... ë‹¤ìš´ë¡œë“œ ë¡œì§ ë° íŒŒì¼ ì €ì¥ ...
        }
    }
}

// SpeziLLMTest4App.swiftì˜, ì•± ì´ˆê¸°í™” ë¡œì§
@main
struct SpeziLLMTest4App: App {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate
    @StateObject private var appModel: AppModel
    
    init() {
        _appModel = StateObject(wrappedValue: AppModel(manager: AppDelegate.shared))
    }
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(appModel)
                .task {
                    appModel.configure()
                }
                .spezi(appDelegate)
        }
    }
}

// AppDelegate êµ¬ì„±
class AppDelegate: SpeziAppDelegate {
    static let shared = LLMManager()
    
    override var configuration: Configuration {
        Configuration(standard: Self.shared) {
            LLMRunner {
                LLMLocalPlatform()
            }
        }
    }
}
